# import_from_git(
#     url: "https://github.com/CruGlobal/cru-fastlane-files",
#     branch: "master",
#     path: "Fastfile"
# )

  # Downloads OneSky localizations by locale to the Xcode project directory and then git adds and commits the localization file.
  #
  # plugin: https://github.com/thekie/fastlane-plugin-onesky
  #
  # options:
  # - one_sky_download_to_project_directory: The directory name localization files should be downloaded to.
  # - one_sky_filename:
  # - one_sky_localizations: Comma separated string list of locales to download from OneSky.
  # - one_sky_project_id:
  # - one_sky_public_key:
  # - one_sky_secret_key:
  # - git_checkout_branch:
  # - create_pull_request_api_token: 
  # - create_pull_request_base:
  # - create_pull_request_repo:
  #
  lane :cru_shared_lane_download_and_commit_latest_one_sky_localizations do |options|

    one_sky_download_to_project_directory = options[:one_sky_download_to_project_directory] || ENV["ONESKY_DOWNLOAD_TO_XCODE_PROJECT_DIRECTORY"]
    one_sky_filename = options[:one_sky_filename] || ENV["ONESKY_FILENAME"]
    one_sky_localizations_string = options[:one_sky_localizations] || ENV["ONESKY_LOCALIZATIONS"]
    one_sky_project_id = options[:one_sky_project_id] || ENV["ONESKY_PROJECT_ID"]
    one_sky_public_key = options[:one_sky_public_key] || ENV["ONESKY_PUBLIC_KEY"]
    one_sky_secret_key = options[:one_sky_secret_key] || ENV["ONESKY_SECRET_KEY"] || ""
    git_checkout_branch = options[:git_checkout_branch]
    create_pull_request_api_token = options[:create_pull_request_api_token] || ENV["GIT_BASIC_AUTHORIZATION_PAT"]
    create_pull_request_base = options[:create_pull_request_base]
    create_pull_request_repo = options[:create_pull_request_repo]
    
    one_sky_localizations_array = one_sky_localizations_string.split(",")

    one_sky_localizations_array.each do |locale|
        
        begin
            
            directory = "../#{one_sky_download_to_project_directory}/#{locale}.lproj"
            Dir.mkdir(directory) unless File.exists?(directory)
            
            onesky_download(
                destination: "./#{one_sky_download_to_project_directory}/#{locale}.lproj/#{one_sky_filename}",
                filename: one_sky_filename,
                locale: locale,
                project_id: one_sky_project_id,
                public_key: one_sky_public_key,
                secret_key: one_sky_secret_key
            )
        rescue
            puts("Failed to import #{locale}")
        end
    end

    begin

        sh('git', 'checkout', git_checkout_branch)
        
        git_add(path: "*/#{one_sky_filename}")
        
        git_commit(
            path: "*/#{one_sky_filename}",
            message: "[skip ci] Adding latest localization files from OneSky"
        )

        create_pull_request(
            api_token: create_pull_request_api_token,
            base: create_pull_request_base,
            repo: create_pull_request_repo,
            title: "Latest OneSky Translations"
        )
    rescue
      puts("Failed to commit localization files.. maybe none to commit?")
    end
  end